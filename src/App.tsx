import { useEffect, useState } from 'react'
import { UserCard } from './UserCard' // –¢–µ–ø–µ—Ä—å –æ—à–∏–±–∫–∞ –¥–æ–ª–∂–Ω–∞ –∏—Å—á–µ–∑–Ω—É—Ç—å
import { CounterPage } from './CounterPage' // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ —Å—á–µ—Ç—á–∏–∫–æ–º
import './App.css'

// 1. –ü–û–î–ì–û–¢–û–í–ö–ê: –û–±—ä—è—Å–Ω—è–µ–º TypeScript, —á—Ç–æ –æ–±—ä–µ–∫—Ç 'window.Telegram' —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
// –≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –ø—Ä–∏ —Å–±–æ—Ä–∫–µ (npm run build) –Ω–µ –±—ã–ª–æ –æ—à–∏–±–æ–∫.
declare global {
  interface Window {
    Telegram: any;
  }
}

function App() {
  // 2. –°–û–°–¢–û–Ø–ù–ò–ï (State): –≠—Ç–æ "–ø–∞–º—è—Ç—å" —Ç–≤–æ–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
  // userData ‚Äî –∑–¥–µ—Å—å –±—É–¥—É—Ç –ª–µ–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —é–∑–µ—Ä–∞ (–∏–º—è, id).
  // setUserData ‚Äî —ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–æ–π –º—ã –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —ç—Ç—É "–ø–∞–º—è—Ç—å".
  const [userData, setUserData] = useState<any>(null);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏
  // 'home' - –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞, 'counter' - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ —Å—á–µ—Ç—á–∏–∫–æ–º
  const [currentPage, setCurrentPage] = useState<'home' | 'counter'>('home');

  // 3. –≠–§–§–ï–ö–¢–´ (useEffect): –≠—Ç–æ—Ç –±–ª–æ–∫ –∫–æ–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –°–ê–ú –æ–¥–∏–Ω —Ä–∞–∑, 
  // –∫–∞–∫ —Ç–æ–ª—å–∫–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã–ª–æ—Å—å –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ.
  useEffect(() => {
    // –°–æ–∑–¥–∞–µ–º –∫–æ—Ä–æ—Ç–∫—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é 'tg', —á—Ç–æ–±—ã –Ω–µ –ø–∏—Å–∞—Ç—å –∫–∞–∂–¥—ã–π —Ä–∞–∑ window.Telegram.WebApp
    const tg = window.Telegram.WebApp;
  
    // –°–æ–æ–±—â–∞–µ–º Telegram, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å –∏ –µ–≥–æ –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
    tg.ready();
  
    // --- –ù–ê–°–¢–†–û–ô–ö–ò –≠–ö–†–ê–ù–ê ---
    
    // –í–∫–ª—é—á–∞–µ–º –Ω–∞—Å—Ç–æ—è—â–∏–π Fullscreen (–µ—Å–ª–∏ –≤–µ—Ä—Å–∏—è Telegram —ç—Ç–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç)
    if (tg.requestFullscreen) {
      tg.requestFullscreen();
    }
  
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º "—à—Ç–æ—Ä–∫—É" –Ω–∞ –º–∞–∫—Å–∏–º—É–º
    tg.expand();
  
    // –ó–∞–ø—Ä–µ—â–∞–µ–º –∑–∞–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–≤–∞–π–ø–æ–º –≤–Ω–∏–∑ (—á—Ç–æ–±—ã –Ω–µ –≤—ã–ª–µ—Ç–µ—Ç—å —Å–ª—É—á–∞–π–Ω–æ)
    if (tg.disableVerticalSwipes) {
      tg.disableVerticalSwipes();
    }
  
    // –í–∫–ª—é—á–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–≤—ã–ª–µ–∑–µ—Ç –æ–∫–Ω–æ "–í—ã —É–≤–µ—Ä–µ–Ω—ã?")
    tg.enableClosingConfirmation();
  
    // --- –¶–í–ï–¢–ê –ò –¢–ï–ú–´ ---

    // –ö—Ä–∞—Å–∏–º –≤–µ—Ä—Ö–Ω—é—é –ø–∞–Ω–µ–ª—å (–≥–¥–µ —á–∞—Å—ã –∏ –∑–∞—Ä—è–¥–∫–∞) –≤ —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    tg.setHeaderColor('secondary_bg_color');
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ —Å–∞–º–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    tg.setBackgroundColor('bg_color');
  
    // --- –î–ê–ù–ù–´–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---

    // –í—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Telegram –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö –≤ –Ω–∞—à—É "–ø–∞–º—è—Ç—å" (state)
    // initDataUnsafe ‚Äî —ç—Ç–æ –æ–±—ä–µ–∫—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–µ–∫—É—â–µ–º —é–∑–µ—Ä–µ
    if (tg.initDataUnsafe?.user) {
      setUserData(tg.initDataUnsafe.user);
    }
  }, []); // –ü—É—Å—Ç—ã–µ —Å–∫–æ–±–∫–∏ –≤ –∫–æ–Ω—Ü–µ –æ–∑–Ω–∞—á–∞—é—Ç: "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ"

  // 4. –§–£–ù–ö–¶–ò–ò: –î–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏
  const onClose = () => {
    window.Telegram.WebApp.close(); // –ö–æ–º–∞–Ω–¥–∞ Telegram –∑–∞–∫—Ä—ã—Ç—å –º–∏–Ω–∏-–∞–ø–ø
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å—á–µ—Ç—á–∏–∫–∞
  const goToCounter = () => {
    setCurrentPage('counter');
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
  const goToHome = () => {
    setCurrentPage('home');
  }

  // 5. –ò–ù–¢–ï–†–§–ï–ô–° (–í–µ—Ä—Å—Ç–∫–∞): –¢–æ, —á—Ç–æ —É–≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —ç–∫—Ä–∞–Ω–µ
  
  // –£—Å–ª–æ–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç currentPage
  if (currentPage === 'counter') {
    return <CounterPage onBack={goToHome} />;
  }

  // –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (home)
  return (
    <div className="App">
      {/* –ó–¥–µ—Å—å –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Ä–Ω–∞—Ä–Ω—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä (—É—Å–ª–æ–≤–∏–µ):
        –ï—Å–ª–∏ userData –µ—Å—Ç—å ‚Äî –ø–∏—à–µ–º –∏–º—è. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–∏—à–µ–º "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å".
      */}
      <h1>–ü—Ä–∏–≤–µ—Ç, {userData ? userData.first_name : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}!</h1>
      
      <div className="card">
        {/* –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç UserCard –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */}
        <UserCard user={userData} />  {/* –ò–°–ü–û–õ–¨–ó–£–ï–ú –ö–ê–ö –¢–ï–ì */}
      </div>

      {/* –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ —Å—á–µ—Ç—á–∏–∫–æ–º */}
      <button 
        onClick={goToCounter} 
        style={{ 
          marginTop: '20px',
          background: '#4dabf7', 
          color: 'white', 
          padding: '12px 24px', 
          border: 'none', 
          borderRadius: '10px', 
          fontWeight: 'bold',
          cursor: 'pointer',
          marginRight: '10px'
        }}
      >
        üî¢ –û—Ç–∫—Ä—ã—Ç—å —Å—á–µ—Ç—á–∏–∫
      </button>

      {/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è */}
      <button 
        onClick={onClose} 
        style={{ 
          marginTop: '20px',
          background: 'red', 
          color: 'white', 
          padding: '12px 24px', 
          border: 'none', 
          borderRadius: '10px', 
          fontWeight: 'bold',
          cursor: 'pointer' 
        }}
      >
        –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      </button>
    </div>
  )
}

export default App