#!/bin/bash

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –ü—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
PROJECT_DIR="/var/www/React"

echo -e "${YELLOW}üöÄ –ù–∞—á–∏–Ω–∞—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞...${NC}"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd "$PROJECT_DIR" || {
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é $PROJECT_DIR${NC}"
    exit 1
}

echo -e "${GREEN}‚úì –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $PROJECT_DIR${NC}"

# –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ Git
echo -e "${YELLOW}üì• –û–±–Ω–æ–≤–ª—è—é –∫–æ–¥ –∏–∑ Git...${NC}"
if git pull; then
    echo -e "${GREEN}‚úì –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω${NC}"
else
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–¥–∞ –∏–∑ Git${NC}"
    exit 1
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo -e "${YELLOW}üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏...${NC}"
if npm install; then
    echo -e "${GREEN}‚úì –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã${NC}"
else
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π${NC}"
    exit 1
fi

# –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
echo -e "${YELLOW}üî® –°–æ–±–∏—Ä–∞—é –ø—Ä–æ–µ–∫—Ç...${NC}"
if npm run build; then
    echo -e "${GREEN}‚úì –ü—Ä–æ–µ–∫—Ç —Å–æ–±—Ä–∞–Ω${NC}"
else
    echo -e "${RED}‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ –ø—Ä–æ–µ–∫—Ç–∞${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ –°–∞–π—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!${NC}"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Telegram –±–æ—Ç–∞
echo -e "${YELLOW}ü§ñ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é Telegram –±–æ—Ç–∞...${NC}"
BOT_DIR="$PROJECT_DIR/telegram-bot"

if [ -d "$BOT_DIR" ]; then
    cd "$BOT_DIR" || {
        echo -e "${RED}‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é $BOT_DIR${NC}"
        exit 1
    }
    
    PID_FILE="bot.pid"
    LOG_FILE="bot.log"
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞, –µ—Å–ª–∏ –æ–Ω –∑–∞–ø—É—â–µ–Ω
    if [ -f "$PID_FILE" ]; then
        BOT_PID=$(cat "$PID_FILE")
        if ps -p "$BOT_PID" > /dev/null 2>&1; then
            echo -e "${YELLOW}‚èπÔ∏è  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –±–æ—Ç–∞ (PID: $BOT_PID)...${NC}"
            kill "$BOT_PID"
            rm "$PID_FILE"
            sleep 1
        else
            rm "$PID_FILE"
        fi
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ config.py —Ñ–∞–π–ª–∞
    if [ ! -f "config.py" ]; then
        echo -e "${YELLOW}‚ö†Ô∏è  –§–∞–π–ª config.py –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞—é –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞${NC}"
    else
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–µ
        echo -e "${YELLOW}üöÄ –ó–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ...${NC}"
        nohup python3 bot.py > "$LOG_FILE" 2>&1 &
        BOT_PID=$!
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º PID
        echo $BOT_PID > "$PID_FILE"
        
        echo -e "${GREEN}‚úì –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω (PID: $BOT_PID)${NC}"
        echo -e "${YELLOW}üí° –õ–æ–≥–∏: tail -f $BOT_DIR/$LOG_FILE${NC}"
    fi
else
    echo -e "${YELLOW}‚ö†Ô∏è  –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $BOT_DIR –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞—é –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞${NC}"
fi